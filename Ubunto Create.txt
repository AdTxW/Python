import os
import tkinter as tk
from tkinter import filedialog

def ask_for_vivaldi_path():
    """ÙØªØ­ Ù†Ø§ÙØ°Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØªØ´ØºÙŠÙ„ Vivaldi"""
    root = tk.Tk()
    root.withdraw()  # Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù€ Tkinter
    vivaldi_path = filedialog.askopenfilename(
        title="Ø­Ø¯Ø¯ Ù…Ù„Ù ØªØ´ØºÙŠÙ„ Vivaldi",
        filetypes=[("Executable Files", "*")]
    )
    if not vivaldi_path:
        print("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ù„Ù ØªØ´ØºÙŠÙ„ Vivaldi. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª.")
        exit()
    return vivaldi_path

def get_existing_profiles():
    """Ø¥Ø±Ø¬Ø§Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù…Ø¬Ù„Ø¯ Vivaldi"""
    user_data_path = os.path.expanduser("~/.config/vivaldi")
    if not os.path.exists(user_data_path):
        return {}

    return {folder: os.path.join(user_data_path, folder)
            for folder in os.listdir(user_data_path) if folder.startswith("Profile ")}

def create_desktop_shortcut(profile_name, vivaldi_path, desktop_path):
    """Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØµØ§Ø± Ù„Ù…Ù„Ù Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ù…Ø¹ÙŠÙ† Ø¹Ù„Ù‰ Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ ÙÙŠ Linux"""
    shortcut_path = os.path.join(desktop_path, f"{profile_name}.desktop")
    
    shortcut_content = f"""[Desktop Entry]
Type=Application
Name={profile_name}
Exec={vivaldi_path} --profile-directory="{profile_name}"
Icon={vivaldi_path}
Terminal=false
"""

    with open(shortcut_path, "w") as shortcut_file:
        shortcut_file.write(shortcut_content)

    # Ø¬Ø¹Ù„ Ø§Ù„Ø§Ø®ØªØµØ§Ø± Ù‚Ø§Ø¨Ù„Ø§Ù‹ Ù„Ù„ØªØ´ØºÙŠÙ„
    os.chmod(shortcut_path, 0o755)
    
    print(f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØµØ§Ø±: {shortcut_path}")

def create_new_profiles(num_users):
    """Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø¹Ø¯Ø¯ ÙƒØ§ÙÙŠÙ‹Ø§"""
    user_data_path = os.path.expanduser("~/.config/vivaldi")
    existing_profiles = get_existing_profiles()
    existing_count = len(existing_profiles)

    if existing_count >= num_users:
        print(f"ğŸ”¹ Ù„Ø¯ÙŠÙƒ Ø¨Ø§Ù„ÙØ¹Ù„ {existing_count} Ø¨Ø±ÙˆÙØ§ÙŠÙ„. Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯.")
        return existing_profiles

    for i in range(existing_count + 1, num_users + 1):
        profile_name = f"Profile {i}"
        profile_path = os.path.join(user_data_path, profile_name)

        if not os.path.exists(profile_path):
            os.makedirs(profile_path)
            print(f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø¬Ø¯ÙŠØ¯: {profile_name}")

    return get_existing_profiles()

def main():
    vivaldi_path = ask_for_vivaldi_path()
    desktop_path = os.path.join(os.path.expanduser("~"), "Desktop", "VivaldiProfiles")

    if not os.path.exists(desktop_path):
        os.makedirs(desktop_path)

    num_users = int(input("ğŸŸ¢ ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ØŸ "))

    profiles = create_new_profiles(num_users)

    for profile_name, profile_path in profiles.items():
        create_desktop_shortcut(profile_name, vivaldi_path, desktop_path)

if __name__ == "__main__":
    main()
